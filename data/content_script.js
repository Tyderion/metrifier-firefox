// Generated by CoffeeScript 1.6.2
var console, converted, min_celsius, prefSet;

console = unsafeWindow.console;

converted = {
  fahrenheit: []
};

min_celsius = -273.15;

prefSet = null;

self.port.on("setPrefs", function(payload) {
  prefSet = payload;
  return console.log("converting to", prefSet.prefs.temperature_to);
});

self.port.on("convert", function(payload) {
  var celsius, elems, myArray, myRe, newRegex, newval, num, replaced, str;

  console.log("Converting");
  elems = $('*');
  myRe = new RegExp("([0-9]+) (?:" + payload + ")", "gi");
  console.log("converting to", prefSet.prefs.temperature_to);
  str = $('body').html();
  myArray = void 0;
  replaced = str;
  while ((myArray = myRe.exec(replaced)) !== null) {
    newRegex = new RegExp("" + myArray[0]);
    num = parseFloat(myArray[1]);
    celsius = (num - 32) / 1.8;
    if (prefSet.prefs.temperature_unit === "kelvin") {
      celsius += min_celsius;
    }
    celsius = Number(celsius.toFixed(2));
    newval = celsius + " " + prefSet.prefs.temperature_unit.trim();
    console.log(newval);
    converted.fahrenheit.push({
      newval: newval,
      oldval: myArray[0]
    });
    replaced = replaced.replace(newRegex, newval);
  }
  return $('body').html(replaced);
});

self.port.on("undo", function(payload) {
  var reg, replaced, undo, _i, _len, _ref;

  console.log("Undoing", payload === "all");
  replaced = $('body').html();
  if (payload === "fahrenheit" || payload === "all") {
    _ref = converted.fahrenheit;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      undo = _ref[_i];
      reg = new RegExp("" + undo.newval);
      replaced = replaced.replace(undo.newval, undo.oldval);
    }
  }
  return $('body').html(replaced);
});

self.port.on("log", function(payload) {
  return console.log(payload);
});
